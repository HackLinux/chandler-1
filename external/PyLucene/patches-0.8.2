--- PyLucene-0.8.2/Makefile	Tue Nov  2 11:08:16 2004
+++ PyLucene-0.8.2-patched/Makefile	Sun Nov  7 11:43:36 2004
@@ -97,59 +97,63 @@
 BINDIR=debug
 else
 COMP_OPT=
 SUFFIX=
 _SUFFIX=
 BINDIR=release
 endif
 
+SWIG_OPT=-DSWIG_COBJECT_TYPES
+
 JCCFLAGS=--encoding=UTF-8
 #JCCFLAGS=--encoding=UTF-8 -findirect-dispatch
 
 ifeq ($(OS),Darwin)
 PYTHON_SITE=$(PREFIX_PYTHON)/lib/python$(PYTHON_VER)/site-packages
 PYTHON_INC=$(PREFIX_PYTHON)/include/python$(PYTHON_VER)
 PYLUCENE_LIB=$(BINDIR)/_PyLucene.so
 LIBDB_JAVA_LIB=$(BINDIR)/libdb_java-4.2.jnilib
 ifeq ($(DEBUG),1)
 CCFLAGS=-O0 -g
 LDFLAGS=-g
 else
-CCFLAGS=-O3
+CCFLAGS=-O2
 LDFLAGS=
 endif
 else
 
 ifeq ($(OS),Linux)
 PYTHON_SITE=$(PREFIX_PYTHON)/lib/python$(PYTHON_VER)/site-packages
 PYTHON_INC=$(PREFIX_PYTHON)/include/python$(PYTHON_VER)
 PYLUCENE_LIB=$(BINDIR)/_PyLucene.so
 LIBDB_JAVA_LIB=$(BINDIR)/libdb_java-4.2.so
 ifeq ($(DEBUG),1)
 CCFLAGS=-O0 -g -fPIC
 LDFLAGS=-g
 else
-CCFLAGS=-O3 -fPIC
+CCFLAGS=-O2 -fPIC
 LDFLAGS=
 endif
 else
 
 ifeq ($(OS),Cygwin)
 PYTHON_SITE=`cygpath -aw $(PREFIX_PYTHON)/Lib/site-packages`
 PYTHON_INC=`cygpath -aw $(PREFIX_PYTHON)/Include`
 PYTHON_PC=`cygpath -aw $(PREFIX_PYTHON)/PC`
 PYLUCENE_LIB=$(BINDIR)/_PyLucene$(_SUFFIX).pyd
 LIBDB_JAVA_LIB=$(BINDIR)/libdb_java42$(SUFFIX).dll
 ifeq ($(DEBUG),1)
 CCFLAGS=-O -g 
 LDFLAGS=-g
+PYDBG=-DPy_TRACE_REFS
 else
-CCFLAGS=-O3
+CCFLAGS=-O2
 LDFLAGS=
+PYDBG=
 endif
 else
 
 PYTHON=unknown
 PYTHON_SITE=unknown
 endif
 endif
 endif
@@ -219,23 +223,23 @@
 
 ifeq ($(OS),Cygwin)
 DB_SRCS=`find $(DB)/java/src/com/sleepycat/db -regex '.*/db/[^/]*java' -exec cygpath -aw {} \;` 
 DB_CONST=`cygpath -aw $(DB)/java/src/com/sleepycat/db/$(BINDIR)/DbConstants.java`
 DB_INC=-I`cygpath -aw $(PREFIX_DB)` -I`cygpath -aw $(PREFIX_DB)/dbinc` -I`cygpath -aw $(PREFIX_DB)/build_win32`
 else
 DB_SRCS=`find $(DB)/java/src/com/sleepycat/db -regex '.*/db/[^/]*java'`
 DB_CONST=$(DB)/java/src/com/sleepycat/db/$(BINDIR)/DbConstants.java
-DB_INC=-I$(PREFIX_DB)/include -I$(DB) -I$(DB)/build_unix
+DB_INC=-I$(PREFIX_DB)/include -I$(DB) -I$(DB)/$(BUILD_DB)
 endif
 
 STORE_SRCS=`find store-$(LUCENE_VER) -name '*.java' -print`
 OBJS:=$(BINDIR)/store.o $(BINDIR)/db_const.o $(BINDIR)/db.o $(OBJS)
 LIBS:=$(LIBDB_JAVA_LIB) $(LIBS)
-SWIG_OPT=-D_WITH_DB_DIRECTORY=1
+SWIG_OPT:=$(SWIG_OPT) -D_WITH_DB_DIRECTORY=1
 
 $(BINDIR)/db_const.o:
 	$(JCC) $(JCCFLAGS) -C -d $(CLASSES) $(DB_CONST)
 	$(JCC) -fjni $(JCCFLAGS) $(CCFLAGS) -c -o $(BINDIR)/db_const.o $(DB_CONST)
 
 $(BINDIR)/db.o: $(BINDIR)/db_const.o
 	$(JCC) $(JCCFLAGS) -C -d $(CLASSES) --classpath=$(CLASSES) $(DB_SRCS)
 	$(JCC) -fjni $(JCCFLAGS) $(CCFLAGS) -c -o $(BINDIR)/db.o --classpath=$(CLASSES) $(DB_SRCS)
@@ -263,17 +267,16 @@
 
 $(BINDIR)/store.o: $(BINDIR)/db.o $(BINDIR)/lucene.o
 	$(JCC) -C -d $(CLASSES) --classpath=$(PYLUCENE_CP) $(STORE_SRCS)
 	$(JCC) -fjni $(CCFLAGS) -c -o $(BINDIR)/store.o --classpath=$(PYLUCENE_CP) $(STORE_SRCS)
 
 else
 
 DISTRIB=PyLucene-$(VERSION)
-SWIG_OPT=
 DB_INC=
 
 endif
 
 ifeq ($(OS),Cygwin)
 _lucene=`cygpath -aw $(LUCENE)`
 else
 _lucene=$(LUCENE)
@@ -532,16 +535,19 @@
 
 
 all: env sources $(BINDIR) $(LIBS)
 	@echo build of $(PYLUCENE_LIB) complete
 
 install:: all
 	install PyLucene.py $(PYTHON_SITE)
 	install $(PYLUCENE_LIB) $(PYTHON_SITE)
+	mkdir -p $(PYTHON_SITE)/security
+	install $(GCJ_HOME)/lib/security/classpath.security $(PYTHON_SITE)/security
+	install $(GCJ_HOME)/lib/security/libgcj.security $(PYTHON_SITE)/security
 
 ifeq ($(OS),Darwin)
 install::
 ifdef DB
 	install $(LIBDB_JAVA_LIB) $(PREFIX_DB)/lib
 	install libdb_java-4.2.la.osx $(PREFIX_DB)/lib/libdb_java-4.2.la
 endif
 	install $(GCJ_HOME)/lib/libgcj.5.dylib $(PREFIX)/lib
@@ -549,22 +555,25 @@
 	install $(GCJ_HOME)/lib/libgcc_s.1.0.dylib $(PREFIX)/lib
 else
 
 ifeq ($(OS),Linux)
 install::
 ifdef DB
 	install $(LIBDB_JAVA_LIB) $(PREFIX_DB)/lib
 endif
+	install $(GCJ_HOME)/lib/libgcj.so.5 $(PREFIX)/lib
+	install $(GCJ_HOME)/lib/libstdc++.so.6 $(PREFIX)/lib
+	install $(GCJ_HOME)/lib/libgcc_s.so.1 $(PREFIX)/lib
 else
 
 ifeq ($(OS),Cygwin)
 install::
 ifdef DB
-	install $(LIBDB_JAVA_LIB) $(PREFIX_DB)/build_win32/$(BINDIR)
+	install $(LIBDB_JAVA_LIB) $(PREFIX)/bin
 endif
 endif
 endif
 endif
 
 
 clean:
 	rm -rf $(BINDIR) PyLucene.py* PyLucene_wrap.cxx
--- PyLucene-0.8.2/PyLucene.i	Tue Nov  2 17:56:44 2004
+++ PyLucene-0.8.2-patched/PyLucene.i	Tue Nov  2 18:07:40 2004
@@ -2359,16 +2359,37 @@
 #endif
 
     objects = new java::util::Hashtable();
 
     java::util::Hashtable *props = (java::util::Hashtable *)
         java::lang::System::getProperties();
     props->put(JvNewStringUTF("inPython"), objects);
 
+    PyObject *sys = PyImport_ImportModule("sys");
+    PyObject *path = PyObject_GetAttrString(sys, "path");
+    int count = PyList_Size(path);
+
+    while (count-- > 0) {
+        PyObject *pp = PyList_GET_ITEM(path, count);
+        char *p = PyString_AsString(pp);
+        int l = strlen(p);
+
+        if (l > 13 && !strcmp(p + l - 13, "site-packages"))
+        {
+            jstring jp = JvNewStringUTF(p);
+
+            props->put(JvNewStringUTF("gnu.classpath.home.url"),
+                       JvNewStringUTF("file:")->concat(jp->replace('\\','/')));
+            break;
+        }
+    }
+    Py_DECREF(path);
+    Py_DECREF(sys);
+
     JvInitClass(&java::util::Locale::class$);
     JvInitClass(&org::apache::lucene::analysis::StopAnalyzer::class$);
     JvInitClass(&org::apache::lucene::document::Field::class$);
     JvInitClass(&org::apache::lucene::queryParser::QueryParser::class$);
     JvInitClass(&org::apache::lucene::search::BooleanQuery::class$);
     JvInitClass(&org::apache::lucene::search::SortField::class$);
     JvInitClass(&org::apache::lucene::search::Sort::class$);
     JvInitClass(&org::apache::lucene::store::FSDirectory::class$);
