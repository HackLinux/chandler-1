
include ../Makefile.inc

RELVER=2.5.3.1-6
SRC=$(INTERNAL)/wxPython-2.5

ifeq ($(DEBUG),1)
CONF_OPT=--enable-debug
DIST_OPT=--debug
FINAL=0
SUFFIX=d
PYTHON_SUFFIX=_d
else
CONF_OPT=--enable-optimized
DIST_OPT=
FINAL=1
SUFFIX=
PYTHON_SUFFIX=
endif



BUILD=build_$(SNAP)

.PHONY: wxWidgets wxPython


ifeq ($(OS),Cygwin)

wxWidgets:
	cd $(SRC); \
        export WXWIN=`cygpath -aw $(SRC)`; MAKEFLAGS=; \
	devenv.com build/msw/msw.sln /build $(Snap)
	mkdir -p $(PREFIX)/$(SITE)/wx
	install $(SRC)/lib/vc_dll/*253$(SUFFIX)*_vc.dll $(PREFIX)/$(SITE)/wx

wxPython:
	cd $(SRC)/wxPython; \
        export WXWIN=`cygpath -aw $(SRC)`; MAKEFLAGS=; \
	cp $(SRC)/wxPython/src/winxp.manifest $(BUILD_ROOT)/$(SNAP)/bin/chandler.exe.manifest; \
	cp $(SRC)/wxPython/src/winxp.manifest $(BUILD_ROOT)/$(SNAP)/bin/python$(PYTHON_SUFFIX).exe.manifest; \
	chmod a+x $(BUILD_ROOT)/$(SNAP)/bin/python$(PYTHON_SUFFIX).exe.manifest; \
	$(PYTHON) setup.py BUILD_BASE=$(BUILD) BUILD_ACTIVEX=0 \
                           USE_SWIG=0 \
                           SWIG=`cygpath -aw $(SWIG)` \
                           INSTALL_MULTIVERSION=0 \
                           MONOLITHIC=0 \
                           build $(DIST_OPT) \
                           install \
                           FINAL=$(FINAL) HYBRID=0

MANIFEST=$(SNAP)/$(SITE)/wx $(SNAP)/bin/chandler.exe.manifest $(SNAP)/bin/python$(PYTHON_SUFFIX).exe.manifest

clean:
	rm -rf $(SRC)/wxPython/$(BUILD)
	cd $(SRC); MAKEFLAGS=; devenv.com build/msw/msw.sln /clean $(Snap)

cleanmanifest:
	cd $(BUILD_ROOT); \
	find $(MANIFEST) -name "*.pyc" | xargs rm -f; \
	find $(MANIFEST) -name "*.pyo" | xargs rm -f

else

ifeq ($(OS),Darwin)

$(SRC)/$(BUILD)/Makefile:
	cd $(SRC); mkdir -p $(BUILD); cd $(BUILD); \
	../configure --prefix=$(PREFIX) $(CONF_OPT) \
                     --enable-monolithic \
                     --enable-geometry \
                     --enable-sound \
                     --with-sdl \
                     --enable-display \
                     --with-libpng \
                     --with-mac \
                     --with-opengl

wxPython:
	cd $(SRC)/wxPython; \
        $(PYTHON) setup.py BUILD_OGL=0 BUILD_GLCANVAS=0 \
                           USE_SWIG=0 \
                           SWIG=$(SWIG) \
                           INSTALL_MULTIVERSION=0 \
                           BUILD_BASE=$(BUILD) \
                           WX_CONFIG=$(PREFIX)/bin/wx-config \
                           build $(DIST_OPT) install FINAL=$(FINAL)

MANIFEST=$(SNAP)/$(SITE)/wx \
         $(SNAP)/$(SITE)/wxPython \
	 $(SNAP)/lib/libwx* \
	 $(SNAP)/share/locale

cleanmanifest:
	cd $(BUILD_ROOT); \
	find $(SNAP)/$(SITE)/wx -name "*.pyc" | xargs rm -f; \
	find $(SNAP)/$(SITE)/wxPython -name "*.pyc" | xargs rm -f; \
	find $(SNAP)/$(SITE)/wx -name "*.pyo" | xargs rm -f; \
	find $(SNAP)/$(SITE)/wxPython -name "*.pyo" | xargs rm -f

else

$(SRC)/$(BUILD)/Makefile:
	cd $(SRC); mkdir -p $(BUILD); cd $(BUILD); \
	../configure --prefix=$(PREFIX) $(CONF_OPT) \
                     --enable-monolithic \
                     --enable-geometry \
                     --enable-sound \
                     --with-sdl \
                     --enable-display \
                     --with-libpng \
                     --with-gtk \
                     --enable-gtk2 \
                     --enable-unicode

wxPython:
	cd $(SRC)/wxPython; \
        $(PYTHON) setup.py BUILD_OGL=0 BUILD_GLCANVAS=0 \
                           USE_SWIG=0 \
                           SWIG=$(SWIG) \
                           INSTALL_MULTIVERSION=0 \
                           BUILD_BASE=$(BUILD) \
                           WX_CONFIG=$(PREFIX)/bin/wx-config \
                           WXPORT=gtk2 UNICODE=1 \
                           build $(DIST_OPT) install FINAL=$(FINAL)

MANIFEST=$(SNAP)/$(SITE)/wx \
         $(SNAP)/$(SITE)/wxPython \
	 $(SNAP)/lib/libwx* \
	 $(SNAP)/share/locale

cleanmanifest:
	cd $(BUILD_ROOT); \
	find $(SNAP)/$(SITE)/wx -name "*.pyc" | xargs rm -f; \
	find $(SNAP)/$(SITE)/wxPython -name "*.pyc" | xargs rm -f; \
	find $(SNAP)/$(SITE)/wx -name "*.pyo" | xargs rm -f; \
	find $(SNAP)/$(SITE)/wxPython -name "*.pyo" | xargs rm -f

endif

wxWidgets: $(SRC)/$(BUILD)/Makefile
	$(MAKE) -C $(SRC)/$(BUILD)
	$(MAKE) -C $(SRC)/$(BUILD)/contrib/src/gizmos
	$(MAKE) -C $(SRC)/$(BUILD)/contrib/src/ogl \
                CXXFLAGS="-DwxUSE_DEPRECATED=0"
	$(MAKE) -C $(SRC)/$(BUILD)/contrib/src/stc
	$(MAKE) -C $(SRC)/$(BUILD) install
	$(MAKE) -C $(SRC)/$(BUILD)/contrib/src/gizmos install
	$(MAKE) -C $(SRC)/$(BUILD)/contrib/src/ogl install
	$(MAKE) -C $(SRC)/$(BUILD)/contrib/src/stc install

clean:
	cd $(SRC); rm -rf $(BUILD); \
	cd $(SRC)/wxPython; rm -rf $(BUILD)

endif

build: wxWidgets wxPython

realclean: clean
	rm -f wxPython-debug-*.tar.gz* wxPython-release-*.tar.gz*

upload: wxPython-$(SNAP)-$(RELVER).tar.gz
	scp wxPython-$(SNAP)-$(RELVER).tar.gz $(UPLOAD)
	scp wxPython-$(SNAP)-$(RELVER).tar.gz.md5 $(UPLOAD)

snap: cleanmanifest
	cd $(BUILD_ROOT); \
	tar -cvzf $(SRC)/wxPython-$(SNAP)-$(RELVER).tar.gz $(MANIFEST)
	$(MD5) wxPython-$(SNAP)-$(RELVER).tar.gz > wxPython-$(SNAP)-$(RELVER).tar.gz.md5

install:
	cd $(BUILD_ROOT); \
	tar -cf - $(MANIFEST) | tar -C $(CHANDLERBIN) -xvf -
